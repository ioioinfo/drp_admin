<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>menu</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="http://libs.baidu.com/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
<script src="js/lodash.min.js" type="text/javascript"></script>
<style type="text/css">
	.weui_mask{
		position: fixed;
		z-index: 10;
		width: 100%;
		height: 100%;
		top: 0;
		left: 0;
		background: rgba(0, 0, 0, 0.6);
	}
	.weui_dialog{
		position: fixed;
		z-index: 13;
		width: 540px;
		height: 500px;
		top: 50%;
		left: 50%;
		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
		background-color: #FAFAFC;
		border-radius: 3px;
		overflow: hidden;
	}
</style>
</head>
<body>
	<div>
	  查询订单号：
	  <input type="text" name="" value="" id="search_order">
	</div>
	<div>
		<input class="find_all" type="button" value="查询所有订单"/>
	</div>
	<div style="width:100%;" id="all_orders"></div>
	<div id="order_table"></div>
	<script id="all_orders_infos" type="text/template">
		<% _.forEach(orders, function(order,index) { %>
			<div class="click_order_info" data-id="<%- order.order_id %>">
				<span>日期：<%- order.order_date_text %></span>
				<span>订单号：<%- order.order_id %></span>
				<span>订单人：<%- order.person_id %></span>
				<span>可获积分：<%- order.gain_point %></span>
				<span>门店：<%- order.store_id %></span>
				<span>实付：<%- order.actual_price %></span>
				<span>总数：<%- order.total_number %></span>
				<span>重量：<%- order.weight %></span>
				<span>运费：<%- order.logistics_price %></span>
				<span>收货人：<%- order.linkname %></span>
				<span>收货地址：<%- order.detail_address %></span>
				<span>收货人手机：<%- order.mobile %></span>
				<span>省：<%- order.province %></span>
				<span>市：<%- order.city %></span>
				<span>区：<%- order.district %></span>
				<span>买家留言：<%- order.send_seller %></span>
				<span>状态：<%- order.order_status %></span>
			</div>
			<div>-------------------------------------------------------</div>
		<% }); %>
	</script>
	<script id="order_table_infos" type="text/template">
		<% _.forEach(details, function(detail,index) { %>
			<div>
				<%- index+1 %>
				<span>数量：<%- detail.order_id %></span>
				<% if (products[detail.product_id].img) { %>
					<img src="{{image_host}}/images/<%- products[detail.product_id].img.location %>" alt="" width="30px" />
				<% } %>
				<span>名称：<%- products[detail.product_id].product_name %></span>
				<span>价格：<%- detail.price %></span>
				<span>数量：<%- detail.number %></span>
				<span>数量：<%- detail.total_price %></span>
			</div>
		<% }); %>
	</script>
	<script>
	$(function(){
		var orders = [];
		var details;
		var products;
		//get方法
		var do_get_method = function(url,params,cb){
			$.get(url,params,function(data){
				if (data.success) {
					cb(data);
				}else {
					alert(data.message);
					return;
				}
			});
		};
		//查询订单详细
		var get_mp_order_details = function(order_id){
			do_get_method("/get_mp_order_details",{"order_id":order_id},function(data){
				if (data.success) {
					details = data.details;
					products = data.products;
					var t = _.template($("#order_table_infos").html());
					$("#order_table").html(t({details:details,products:products}));
					$("#order_infos").removeAttr("style");
				}else {
					alert(data.message);
				}
			});
		};
		//单条查询
		var get_order = function(order_id){
			do_get_method("/get_order",{"order_id":order_id},function(data){
				if (data.success) {
					orders = data.orders;
					var t = _.template($("#all_orders_infos").html());
					$("#all_orders").html(t({orders:orders}));
					$("#orders").removeAttr("style");
					$(".click_order_info").click(function(){
						var order_id = $(this).data("id");
						get_mp_order_details(order_id);
					});
				}else {
					alert(data.message);
				}
			});
		};
		//订单号查询
		$("#search_order").keypress(function(e){
			var search_order = $("#search_order").val();
			var key = e.which;
			if (!search_order || key != 13) {
				return;
			}
			get_order(search_order);
		});
		//查询所有
		$(".find_all").click(function(){
			$.get("/mp_orders_list",function(data){
				if (data.success) {
					orders = data.orders;
					var t = _.template($("#all_orders_infos").html());
					$("#all_orders").html(t({orders:orders}));
					$("#orders").removeAttr("style");
					$(".click_order_info").click(function(){
						var order_id = $(this).data("id");
						get_mp_order_details(order_id);
					});
				}else {
					alert(data.message);
				}
			});
		});

	});
	</script>
</body>
</html>
